#!/usr/bin/env bash

current_script_path="${BASH_SOURCE[0]}"
plugin_dir=$(dirname "$(dirname "${current_script_path}")")

# shellcheck source=./lib/utils.bash
source "${plugin_dir}/lib/utils.bash"

# See https://github.com/asdf-vm/asdf/blob/master/docs/plugins-create.md#github-api-rate-limiting
fetch() {
  curl --silent --fail --show-error --location ${GITHUB_TOKEN:+-H "Authorization: token ${GITHUB_TOKEN}"} "$@"
}

if [[ "${ASDF_INSTALL_TYPE:-version}" == 'ref' ]]; then
  echo >&2 "â›” This plugin does not support installing by ref."
  exit 1
fi

mkdir -p "${ASDF_DOWNLOAD_PATH}"

if [ "${ASDF_INSTALL_VERSION:-latest}" = "latest" ]; then
  ASDF_INSTALL_VERSION="$(list_versions | sort_versions | tail -n 1)"
fi

echo "Downloading pre-commit v${ASDF_INSTALL_VERSION}"

fetch \
  "https://github.com/pre-commit/pre-commit/releases/download/v${ASDF_INSTALL_VERSION}/pre-commit-${ASDF_INSTALL_VERSION}.pyz" \
  -o "${ASDF_DOWNLOAD_PATH}/pre-commit"
chmod +x "${ASDF_DOWNLOAD_PATH}/pre-commit"
